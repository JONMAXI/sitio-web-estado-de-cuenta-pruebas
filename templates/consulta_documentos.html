<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consulta de Documentos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body { background-color: #f8f9fa; margin:0; padding:0; font-family: Arial, sans-serif; }
.header-bar { background-color: white; padding: 0.75rem 1rem; box-shadow: 0 0 10px rgba(0,0,0,0.05); margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
.logo { max-height: 50px; }
.card-custom { border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 1.5rem; background-color: #fff; margin-bottom: 1.5rem; }
#visorContainer { position: relative; min-height: 400px; max-height: 80vh; }
#pdfFrame { width: 100%; height: 80vh; border:1px solid #ccc; }
#watermarkCanvas { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; }
#loader { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
.btn-custom { background-color: #0d6efd; color: white; font-weight: 500; border-radius: 8px; }
.btn-custom:hover { background-color: #084298; }
</style>
</head>
<body>

<div class="header-bar">
  <div class="d-flex align-items-center flex-wrap">
    <img src="https://maxikash.mx/cdn/shop/files/Logotipo-Maxikash-Outline.png?v=1749328460" alt="Logo" class="logo me-2">
    <h5 class="mb-0 text-secondary">Consulta de Documentos</h5>
  </div>
  {% if session.get('usuario') %}
  <div class="text-end mt-2 mt-md-0 d-flex flex-wrap gap-1">
    <a href="/" class="btn btn-outline-primary">Consulta Estado de Cuenta</a>
    <a href="/logout" class="btn btn-outline-danger">Cerrar sesión</a>
  </div>
  {% endif %}
</div>

<div class="container py-2">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8">
            <div class="card card-custom">
                <h3 class="text-center mb-4">Consulta Documentos</h3>
                <form id="formConsulta" class="d-flex flex-column">
                    <div class="mb-3">
                        <label for="idDocumento" class="form-label">ID Crédito / Persona</label>
                        <input type="text" class="form-control" id="idDocumento" required pattern="\d{1,10}" maxlength="10" title="Solo números, máximo 10 dígitos">
                    </div>
                    <div class="mb-3">
                        <label for="tipoDocumento" class="form-label">Tipo de Documento</label>
                        <select id="tipoDocumento" class="form-select" required>
                            <option value="INE">INE (Frente + Reverso)</option>
                            <option value="Contrato">Contrato</option>
                            <option value="Factura">Factura</option>
                            <option value="FAD_DOC">FAD_DOC</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-custom w-100 mt-3">Buscar Documento</button>
                </form>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-12" id="visorContainer" style="display:none;">
            <div class="card card-custom" style="position:relative;">
                <h3 class="text-center mb-4">Visor de Documento</h3>

                <div id="loader" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <div>Cargando documento...</div>
                </div>

                <!-- Google Chrome PDF Viewer nativo -->
                <iframe id="pdfFrame" type="application/pdf"></iframe>
                <canvas id="watermarkCanvas"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
const iframe = document.getElementById('pdfFrame');
const canvas = document.getElementById('watermarkCanvas');
const ctx = canvas.getContext('2d');
let scale = 1.0;

function drawWatermark() {
    const rect = iframe.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.globalAlpha = 0.3;
    ctx.fillStyle = "red";
    ctx.font = `${50 * scale}px Arial`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    const stepX = 200 * scale;
    const stepY = 150 * scale;
    const angle = -Math.PI / 4;
    for(let y=-canvas.height; y<canvas.height*2; y+=stepY){
        for(let x=-canvas.width; x<canvas.width*2; x+=stepX){
            ctx.save();
            ctx.translate(x+stepX/2, y+stepY/2);
            ctx.rotate(angle);
            ctx.fillText("SIN VALOR",0,0);
            ctx.restore();
        }
    }
}

// Form submit
document.getElementById('formConsulta').addEventListener('submit', function(e){
    e.preventDefault();
    const id = document.getElementById('idDocumento').value.trim();
    const tipo = document.getElementById('tipoDocumento').value;
    if(!id) return;

    const url = `/descargar/${id}?tipo=${tipo}`;
    document.getElementById('loader').style.display = 'flex';
    document.getElementById('visorContainer').style.display = 'block';

    iframe.src = url; // Chrome abrirá su visor nativo
    iframe.onload = () => {
        document.getElementById('loader').style.display = 'none';
        drawWatermark();
    };
});
</script>
</body>
</html>
