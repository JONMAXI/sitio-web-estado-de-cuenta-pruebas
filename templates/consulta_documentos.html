<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consulta de Documentos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.13.216/pdf.min.js"></script>

<style>
#visorContainer { position: relative; min-height: 400px; }
#pdfCanvas { border:1px solid #ccc; width: 100%; }
#watermarkCanvas { position:absolute; top:0; left:0; pointer-events:none; }
</style>
</head>
<body>

<div class="container py-2">
    <form id="formConsulta">
        <input type="text" id="idDocumento" placeholder="ID Documento" required>
        <select id="tipoDocumento">
            <option value="Contrato">Contrato</option>
        </select>
        <button type="submit">Buscar</button>
    </form>

    <div id="visorContainer" style="display:none;">
        <canvas id="pdfCanvas"></canvas>
        <canvas id="watermarkCanvas"></canvas>
        <button id="printBtn" class="btn btn-primary mt-2">Imprimir PDF</button>
    </div>
</div>

<script>
const pdfCanvas = document.getElementById('pdfCanvas');
const pdfCtx = pdfCanvas.getContext('2d');
const watermarkCanvas = document.getElementById('watermarkCanvas');
const watermarkCtx = watermarkCanvas.getContext('2d');

async function renderPDF(url) {
    const pdf = await pdfjsLib.getDocument(url).promise;
    const page = await pdf.getPage(1);

    const viewport = page.getViewport({ scale: 1.5 });
    pdfCanvas.width = viewport.width;
    pdfCanvas.height = viewport.height;
    watermarkCanvas.width = viewport.width;
    watermarkCanvas.height = viewport.height;

    await page.render({ canvasContext: pdfCtx, viewport: viewport }).promise;

    drawWatermark();
}

function drawWatermark() {
    const stepX = 200;
    const stepY = 150;
    const angle = -Math.PI/4;
    watermarkCtx.clearRect(0,0,watermarkCanvas.width, watermarkCanvas.height);
    watermarkCtx.globalAlpha = 0.3;
    watermarkCtx.fillStyle = 'red';
    watermarkCtx.font = '50px Arial';
    watermarkCtx.textAlign = 'center';
    watermarkCtx.textBaseline = 'middle';

    for(let y=-watermarkCanvas.height; y<watermarkCanvas.height*2; y+=stepY){
        for(let x=-watermarkCanvas.width; x<watermarkCanvas.width*2; x+=stepX){
            watermarkCtx.save();
            watermarkCtx.translate(x+stepX/2, y+stepY/2);
            watermarkCtx.rotate(angle);
            watermarkCtx.fillText("SIN VALOR",0,0);
            watermarkCtx.restore();
        }
    }
}

// Botón imprimir
document.getElementById('printBtn').addEventListener('click', () => {
    const printWindow = window.open('', '_blank');
    printWindow.document.write('<html><head><title>Imprimir PDF</title></head><body>');
    // combinamos el PDF renderizado con la marca de agua
    printWindow.document.body.appendChild(pdfCanvas.cloneNode(true));
    printWindow.document.body.appendChild(watermarkCanvas.cloneNode(true));
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
});

document.getElementById('formConsulta').addEventListener('submit', e => {
    e.preventDefault();
    const id = document.getElementById('idDocumento').value.trim();
    const tipo = document.getElementById('tipoDocumento').value;

    // Tu URL real aquí
    const url = `/descargar/${id}?tipo=${tipo}`;
    document.getElementById('visorContainer').style.display = 'block';
    renderPDF(url);
});
</script>
</body>
</html>
