<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consulta de Documentos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- PDF.js -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/build/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/build/pdf.worker.min.js';
</script>

<style>
body { background-color: #f8f9fa; margin:0; padding:0; font-family: Arial, sans-serif; }

.header-bar {
  background-color: white;
  padding: 0.75rem 1rem;
  box-shadow: 0 0 10px rgba(0,0,0,0.05);
  margin-bottom: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

.logo { max-height: 50px; }

.card-custom {
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 1.5rem;
    background-color: #fff;
    margin-bottom: 1.5rem;
}

#visorContainer { 
    position: relative;
    min-height: 400px;
    max-height: 80vh;
    overflow-y: auto;
}

/* Loader */
#loader {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.btn-custom { 
    background-color: #0d6efd; 
    color: white; 
    font-weight: 500; 
    border-radius: 8px;
}
.btn-custom:hover { 
    background-color: #084298; 
}

@media (max-width: 768px) {
    .card-custom { padding: 1rem; }
    .header-bar { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
    #visorContainer { max-height: 60vh; }
}

@media (max-width: 576px) {
    .header-bar { padding: 0.5rem; }
    .logo { max-height: 40px; margin-bottom: 0.5rem; }
    .card-custom { padding: 0.8rem; }
    button.btn-custom { font-size: 0.9rem; padding: 0.5rem; }
}
</style>
</head>
<body>

<div class="header-bar">
  <div class="d-flex align-items-center flex-wrap">
    <img src="https://maxikash.mx/cdn/shop/files/Logotipo-Maxikash-Outline.png?v=1749328460" alt="Logo" class="logo me-2">
    <h5 class="mb-0 text-secondary">Consulta de Documentos</h5>
  </div>
  {% if session.get('usuario') %}
  <div class="text-end mt-2 mt-md-0 d-flex flex-wrap gap-1">
    <a href="/" class="btn btn-outline-primary">Consulta Estado de Cuenta</a>
    <a href="/logout" class="btn btn-outline-danger">Cerrar sesión</a>
  </div>
  {% endif %}
</div>

<div class="container py-2">
    <!-- Formulario -->
    <div class="row justify-content-center">
        <div class="col-12 col-md-8">
            <div class="card card-custom">
                <h3 class="text-center mb-4">Consulta Documentos</h3>
                <form id="formConsulta" class="d-flex flex-column">
                    <div class="mb-3">
                        <label for="idDocumento" class="form-label">ID Crédito / Persona</label>
                        <input type="text" class="form-control" id="idDocumento" required 
       pattern="\d{1,10}" maxlength="10" title="Solo números, máximo 10 dígitos">
                    </div>
                    <div class="mb-3">
                        <label for="tipoDocumento" class="form-label">Tipo de Documento</label>
                        <select id="tipoDocumento" class="form-select" required>
                            <option value="INE">INE (Frente + Reverso)</option>
                            <option value="Contrato">Contrato</option>
                            <option value="Factura">Factura</option>
                            <option value="FAD_DOC">FAD_DOC</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-custom w-100 mt-3">Buscar Documento</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Visor de Documento -->
    <div class="row justify-content-center">
        <div class="col-12" id="visorWrapper" style="display:none;">
            <div class="card card-custom" style="position:relative;">
                <h3 class="text-center mb-4">Visor de Documento</h3>

                <!-- Loader -->
                <div id="loader" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <div>Cargando documento...</div>
                </div>

                <!-- Contenedor PDF.js -->
                <div id="visorContainer"></div>

                <!-- Lista de videos -->
                <h4 class="mt-3">Videos embebidos en el PDF:</h4>
                <ul id="videoList"></ul>
            </div>
        </div>
    </div>
</div>

<script>
const visorContainer = document.getElementById('visorContainer');
const videoList = document.getElementById('videoList');
const loader = document.getElementById('loader');
const visorWrapper = document.getElementById('visorWrapper');

const watermarkText = "SIN VALOR";

function drawWatermark(ctx, width, height) {
    ctx.save();
    ctx.globalAlpha = 0.3;
    ctx.fillStyle = "red";
    ctx.font = "50px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    const stepX = 200;
    const stepY = 150;
    const angle = -Math.PI / 4;

    for (let y = -height; y < height*2; y += stepY){
        for (let x = -width; x < width*2; x += stepX){
            ctx.save();
            ctx.translate(x + stepX/2, y + stepY/2);
            ctx.rotate(angle);
            ctx.fillText(watermarkText, 0, 0);
            ctx.restore();
        }
    }
    ctx.restore();
}

async function loadPDF(url) {
    loader.style.display = 'flex';
    visorContainer.innerHTML = '';
    videoList.innerHTML = '';

    try {
        const loadingTask = pdfjsLib.getDocument(url);
        const pdf = await loadingTask.promise;
        const numPages = pdf.numPages;

        for (let i = 1; i <= numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 1.5 });

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            visorContainer.appendChild(canvas);

            await page.render({ canvasContext: ctx, viewport: viewport }).promise;

            drawWatermark(ctx, canvas.width, canvas.height);

            // Detectar videos embebidos
            const annotations = await page.getAnnotations();
            annotations.forEach(a => {
                if (a.subtype === 'RichMedia') {
                    const li = document.createElement('li');
                    li.textContent = `Video detectado en página ${i}: ${a.filename || 'sin nombre'}`;
                    
                    // Para reproducir video si extraes Blob
                    // const videoEl = document.createElement('video');
                    // videoEl.controls = true;
                    // videoEl.src = URL.createObjectURL(new Blob([a.content.data], { type:'video/mp4' }));
                    // li.appendChild(videoEl);

                    videoList.appendChild(li);
                }
            });
        }
    } catch (err) {
        Swal.fire({ icon:'error', title:'Error', text: err.message });
        visorWrapper.style.display = 'none';
    } finally {
        loader.style.display = 'none';
    }
}

// Form submit
document.getElementById('formConsulta').addEventListener('submit', async function(e){
    e.preventDefault();
    const id = document.getElementById('idDocumento').value.trim();
    const tipo = document.getElementById('tipoDocumento').value;
    if(!id) return;

    const url = `/descargar/${id}?tipo=${tipo}`;
    visorWrapper.style.display = 'block';

    loadPDF(url);
});
</script>
</body>
</html>
